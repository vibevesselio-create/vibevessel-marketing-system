name: Webhook Processor (Multi-Node Cloud Worker)

on:
  repository_dispatch:
    types:
      - webhook-event
      - workspace-event
  workflow_dispatch:
    inputs:
      queue_source:
        description: "Queue backend to use (notion|redis|payload)"
        required: false
        default: "notion"
      max_jobs:
        description: "Max jobs per worker execution"
        required: false
        default: "25"
      dry_run:
        description: "If true, do not mutate external systems"
        required: false
        default: "false"

permissions:
  contents: read

concurrency:
  group: webhook-processor-${{ github.ref }}
  cancel-in-progress: false

jobs:
  process:
    name: Process webhook jobs (worker ${{ matrix.worker_id }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        worker_id: [1, 2, 3, 4]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies (minimal)
        run: |
          python -m pip install --upgrade pip
          pip install notion-client requests tenacity pydantic python-dotenv

      - name: Write repository_dispatch payload (if present)
        if: ${{ github.event_name == 'repository_dispatch' }}
        run: |
          python - <<'PY'
          import json, os
          payload = os.environ.get("REPO_DISPATCH_PAYLOAD_JSON", "{}")
          with open("repo_dispatch_payload.json", "w", encoding="utf-8") as f:
              f.write(payload)
          print("Wrote repo_dispatch_payload.json")
          PY
        env:
          REPO_DISPATCH_PAYLOAD_JSON: ${{ toJson(github.event.client_payload) }}

      - name: Run cloud worker
        env:
          # Notion
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_WEBHOOK_JOBS_DB_ID: ${{ secrets.NOTION_WEBHOOK_JOBS_DB_ID }}

          # Redis (optional)
          REDIS_URL: ${{ secrets.REDIS_URL }}

          # Coordinator (optional): where cloud worker forwards work
          MM1_COORDINATOR_URL: ${{ vars.MM1_COORDINATOR_URL }}

          # Operational
          WORKER_ID: ${{ matrix.worker_id }}
          QUEUE_SOURCE: ${{ inputs.queue_source || 'notion' }}
          MAX_JOBS: ${{ inputs.max_jobs || '25' }}
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
          PAYLOAD_FILE: repo_dispatch_payload.json
        run: |
          python scripts/github_actions_webhook_processor.py \
            --worker-id "$WORKER_ID" \
            --queue-source "$QUEUE_SOURCE" \
            --max-jobs "$MAX_JOBS" \
            --dry-run "$DRY_RUN" \
            --payload-file "$PAYLOAD_FILE"

